# Інструкція з використання скетчу MQL 2004 I2C Encoder V2

## Опис

Система керування насосом MQL (Minimum Quantity Lubrication) з LCD дисплеєм 2004, енкодером KY-040 та підтримкою Arduino UNO/Nano/Micro.

## Підключення обладнання

### Підтримувані плати
- ✅ Arduino UNO
- ✅ Arduino Nano
- ✅ Arduino Micro

### Підключення компонентів

#### LCD 2004 I2C
- **SDA** → A4 (UNO/Nano) або 2 (Micro)
- **SCL** → A5 (UNO/Nano) або 3 (Micro)
- **VCC** → 5V
- **GND** → GND
- **Адреса I2C**: 0x27 (за замовчуванням, можна змінити в `config.h`)

#### Енкодер KY-040
- **S1 (A)** → D2
- **S2 (B)** → D3
- **BTN** → A3
- **VCC** → 5V
- **GND** → GND

#### Кнопка START/STOP
- **Кнопка** → A1 (NO → GND)
- **LED** → A2 (через резистор 220Ω)

#### Потенціометр
- **Вихід** → A0
- **VCC** → 5V
- **GND** → GND

#### Драйвер крокового двигуна DM556
- **PUL+** → D12
- **DIR+** → D10
- **ENA+** → D11
- **GND** → GND

## Налаштування перед використанням

### 1. Налаштування адреси LCD
У файлі `config.h` змініть адресу I2C, якщо потрібно:
```cpp
constexpr uint8_t LCD_I2C_ADDR = 0x27;   // або 0x3F
```

### 2. Налаштування енкодера
У файлі `config.h` можна налаштувати:
- `ENC_DETENT_EDGES` - кількість переходів на один "клік" (4 для KY-040)
- `ENC_INVERT_DIR` - інверсія напрямку (true/false)
- `ENC_MIN_EDGE_US` - захист від дребезгу (300 мкс)

### 3. Вибір плати в Arduino IDE
1. Відкрийте `mql_2004_I2C_encoder_V2.ino`
2. Виберіть плату: **Tools → Board → Arduino/Genuino Uno** (або Nano/Micro)
3. Виберіть порт: **Tools → Port**
4. Завантажте скетч

## Керування системою

### Основні елементи керування

#### Енкодер KY-040
- **Обертання** - навігація по меню / зміна значень
- **Коротке натискання (OK)** - вибір / підтвердження
- **Довге натискання (MENU)** - відкриття меню / повернення назад

#### Кнопка START/STOP
- **Натискання** - запуск/зупинка насоса

#### Потенціометр
- **Обертання** - регулювання витрати рідини (в режимі RUN)

## Екрани та режими роботи

### 1. Екран READY (Готово)
**Відображає:**
- Матеріал (Steel/Alum)
- Режим (CONT/PULSE)
- Рекомендовану витрату
- Поточну витрату

**Дії:**
- **OK (коротке)** → відкрити меню
- **MENU (довге)** → відкрити Wizard
- **START** → запустити насос

### 2. Екран RUN (Робота)
**Відображає:**
- Стан насоса (ON/OFF)
- Рекомендовану витрату
- Поточну витрату (регулюється потенціометром)

**Дії:**
- **Потенціометр** → регулювання витрати
- **START** → зупинити насос
- **MENU (довге)** → відкрити меню

### 3. Wizard (Мастер налаштування)

#### Крок 1: Вибір матеріалу (WIZ_MAT)
- **Обертання енкодера** → Steel ↔ Alum
- **OK** → наступний крок

#### Крок 2: Діаметр фрези (WIZ_DIA)
- **Кнопки UP/DOWN** → швидка зміна діаметра (3-50 мм)
  - Перший клік: ±1 мм
  - Утримання 600мс: ±5 мм
  - Утримання 1500мс: ±10 мм
- **OK** → наступний крок

#### Крок 3: Рекомендації (WIZ_REC)
- **Потенціометр** → регулювання витрати
- **START** → запустити з налаштуваннями
- **MENU (довге)** → повернутися в меню

### 4. Меню налаштувань

**Відкриття:** з екрану READY натисніть **OK (коротке)**

**Навігація:**
- **Обертання енкодера** → переміщення по пунктах
- **OK** → вхід/вихід з режиму редагування
- **MENU (довге)** → вихід з меню / скасування змін

#### Пункти меню:

1. **Material** (Матеріал)
   - Steel / Alum
   - Впливає на розрахунок витрати

2. **Cutter D** (Діаметр фрези)
   - 3-50 мм
   - Крок: ±1 мм

3. **Mode** (Режим)
   - CONT (безперервний)
   - PULSE (імпульсний)

4. **Pulse ON** (Імпульс ВКЛ)
   - 100-5000 мс
   - Крок: ±50 мс

5. **Pulse OFF** (Імпульс ВИКЛ)
   - 100-10000 мс
   - Крок: ±100 мс

6. **Kmin** (Мінімальний коефіцієнт)
   - 20-100 (0.20x - 1.00x)
   - Крок: ±2

7. **Kmax** (Максимальний коефіцієнт)
   - 120-400 (1.20x - 4.00x)
   - Крок: ±5

8. **AlFactor** (Коефіцієнт алюмінію)
   - 100-200 (1.00x - 2.00x)
   - Крок: ±2

9. **POT Avg N** (Середнє значення потенціометра)
   - 4 / 8 / 16
   - Фільтрація шуму

10. **POT Hyst** (Гістерезис потенціометра)
    - 0-50 (0.00 - 0.50 u/min)
    - Крок: ±1

11. **PumpGain** (Коефіцієнт насоса)
    - 50-50000 кроків/у/хв
    - Крок: ±50

12. **Calibrate 60s** (Калібрування 60 сек)
    - Запускає калібрування на 60 секунд

13. **Calibrate 120s** (Калібрування 120 сек)
    - Запускає калібрування на 120 секунд

14. **Cal ml/u** (Каліброване значення)
    - Показує результат калібрування
    - Редагування: введення нового значення

15. **Clear calibration** (Очистити калібрування)
    - Скидає калібрування

16. **Save EEPROM** (Зберегти в EEPROM)
    - Зберігає всі налаштування

17. **Load Defaults** (Завантажити за замовчуванням)
    - Скидає всі налаштування до заводських

18. **Language** (Мова)
    - EN (English) / UA (Українська)
    - Зберігається автоматично

19. **LCD Test** (Тест LCD)
    - Тестування відображення символів

## Калібрування насоса

### Процес калібрування:

1. **Запуск калібрування:**
   - Меню → "Calibrate 60s" або "Calibrate 120s"
   - Насос запуститься з витратою 1.00 u/min

2. **Збір рідини:**
   - Зберіть рідину, що вийшла за час калібрування
   - Дочекайтесь завершення (60 або 120 секунд)

3. **Введення значення:**
   - Введіть об'єм зібраної рідини в мл
   - Обертання енкодера → зміна цифри
   - OK → перехід до наступної цифри
   - Після останньої цифри → автоматичне збереження

4. **Результат:**
   - Система розрахує коефіцієнт мл/у
   - Значення зберігається в EEPROM

### Редагування калібрування:
- Меню → "Cal ml/u" → OK → введення нового значення

### Очищення калібрування:
- Меню → "Clear calibration" → OK → підтвердження

## Режими роботи насоса

### CONT (Безперервний)
- Насос працює безперервно з заданою витратою
- Витрата регулюється потенціометром

### PULSE (Імпульсний)
- Насос працює імпульсами
- Налаштування: Pulse ON / Pulse OFF
- Витрата регулюється потенціометром

## Розрахунок витрати

Система автоматично розраховує рекомендовану витрату на основі:
- Матеріалу (Steel / Alum)
- Діаметра фрези
- Коефіцієнтів Kmin, Kmax, AlFactor

**Формула:**
```
Rec = base_flow * material_factor * cutter_factor
```

Діапазон регулювання:
- Мінімум: Rec × Kmin
- Максимум: Rec × Kmax

## Збереження налаштувань

Налаштування зберігаються в EEPROM автоматично при:
- Виборі "Save EEPROM" в меню
- Зміні мови
- Завершенні калібрування

**Увага:** Налаштування зберігаються між перезавантаженнями.

## Технічні параметри

### За замовчуванням:
- Матеріал: Steel
- Діаметр фрези: 10 мм
- Режим: CONT
- Kmin: 0.50x
- Kmax: 2.00x
- AlFactor: 1.30x
- PumpGain: 1000 steps/u/min

### Обмеження:
- Діаметр фрези: 3-50 мм
- Pulse ON: 100-5000 мс
- Pulse OFF: 100-10000 мс
- PumpGain: 50-50000

## Усунення проблем

### LCD не відображає
- Перевірте адресу I2C (0x27 або 0x3F)
- Перевірте підключення SDA/SCL
- Перевірте живлення

### Енкодер не працює
- Перевірте підключення D2, D3, A3
- Перевірте налаштування `ENC_INVERT_DIR`
- Перевірте `ENC_DETENT_EDGES` (4 для KY-040)

### Насос не запускається
- Перевірте підключення DM556 (D10, D11, D12)
- Перевірте налаштування PumpGain
- Перевірте калібрування

### Неправильна витрата
- Виконайте калібрування
- Перевірте налаштування PumpGain
- Перевірте коефіцієнти Kmin/Kmax

## Підтримка плат

### Arduino UNO/Nano
- Підтримка включена за замовчуванням
- Енкодер: D2=PD2, D3=PD3

### Arduino Micro
- Автоматичне визначення через `ARDUINO_AVR_MICRO`
- Енкодер: D2=PD1, D3=PD0
- Інші піни однакові

## Додаткова інформація

### Структура проєкту:
- `mql_2004_I2C_encoder_V2.ino` - основний скетч
- `config.h` - налаштування пінів та параметрів
- `types.h` - типи даних
- `settings.h/cpp` - робота з EEPROM
- `input.h/cpp` - обробка вводу
- `encoder_k040.h/cpp` - драйвер енкодера
- `menu.h/cpp` - система меню
- `ui.h/cpp` - інтерфейс користувача
- `pump.h/cpp` - керування насосом
- `reco.h/cpp` - розрахунок рекомендацій

### Мови інтерфейсу:
- English (EN) - за замовчуванням
- Українська (UA) - через меню

## Ліцензія

Проєкт розроблений для систем MQL (Minimum Quantity Lubrication).

---

**Версія:** 2.0  
**Дата:** 2024  
**Підтримка:** Arduino UNO/Nano/Micro
